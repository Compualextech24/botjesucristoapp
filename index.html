<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hablando con el Maestro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html { 
            height: 100%; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* LOADER INICIAL */
        #loader { 
            position: fixed; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: radial-gradient(circle at center, #1a1a3e 0%, #000 100%); 
            color: white; 
            z-index: 200; 
            text-align: center;
            opacity: 1;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }
        
        #loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* PANTALLA DE ESPERA */
        #celestial-wait { 
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            z-index: 150;
            text-align: center;
        }

        #celestial-wait.active {
            display: flex;
        }

        /* SPINNER */
        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(125, 211, 252, 0.2);
            border-top: 5px solid #7dd3fc;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            filter: drop-shadow(0 0 20px rgba(125, 211, 252, 0.6));
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* ESTRELLA ANIMADA */
        .star-icon {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                filter: drop-shadow(0 0 15px #0ea5e9);
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px #7dd3fc);
                transform: scale(1.1);
            }
        }

        /* BARRA DE PROGRESO */
        #celestial-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9, #fff, #7dd3fc);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.8);
            z-index: 160;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            opacity: 0;
        }

        #celestial-progress.active {
            opacity: 1;
        }

        /* CONTENEDOR DE VIDEO */
        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            background: #000; 
        }

        video { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            transition: opacity 0.4s ease-in-out;
        }

        video.hidden {
            opacity: 0 !important;
        }

        video.visible {
            opacity: 1 !important;
        }
        
        /* T√çTULO PRINCIPAL */
        #main-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: clamp(0.8rem, 2.5vw, 1.1rem);
            font-weight: 900; 
            letter-spacing: 1px; 
            text-shadow: 0 0 20px rgba(125, 211, 252, 0.9), 0 0 40px rgba(14, 165, 233, 0.5);
            z-index: 100;
            opacity: 0;
            width: 95%; 
            text-align: center;
            text-transform: uppercase;
            transition: opacity 0.8s ease-in;
            padding: 10px;
        }

        #main-title.visible {
            opacity: 1;
        }
        
        /* INTERFAZ DE CHAT */
        #chat-ui { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 850px; 
            opacity: 0;
            z-index: 100;
            transition: opacity 0.8s ease-in;
        }

        #chat-ui.visible {
            opacity: 1;
        }
        
        /* HISTORIAL */
        #history { 
            max-height: 45vh; 
            overflow-y: auto; 
            margin-bottom: 15px; 
            padding: 10px 5px; 
            scroll-behavior: smooth;
        }
        
        #history::-webkit-scrollbar { 
            width: 5px; 
        }

        #history::-webkit-scrollbar-track {
            background: rgba(125, 211, 252, 0.1);
            border-radius: 10px;
        }

        #history::-webkit-scrollbar-thumb {
            background: rgba(125, 211, 252, 0.4);
            border-radius: 10px;
        }

        /* INPUT GLASS */
        .glass-input { 
            background: rgba(3, 105, 161, 0.3) !important; 
            backdrop-filter: blur(25px); 
            border: 2px solid rgba(125, 211, 252, 0.3); 
            border-radius: 30px; 
            position: relative; 
            overflow: visible;
            min-height: 56px;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.2);
            transition: border 0.3s ease;
        }

        .glass-input:focus-within {
            border-color: rgba(125, 211, 252, 0.6);
        }

        /* BOT√ìN INICIO */
        .btn-start { 
            background: linear-gradient(135deg, #fff 0%, #e0f2fe 100%);
            color: #0369a1; 
            padding: 20px 50px; 
            border-radius: 60px; 
            font-weight: 900; 
            cursor: pointer; 
            box-shadow: 0 0 50px rgba(125, 211, 252, 0.4), 0 10px 30px rgba(14, 165, 233, 0.3);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1rem;
            border: none;
            outline: none;
        }

        .btn-start:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 0 70px rgba(125, 211, 252, 0.6), 0 15px 40px rgba(14, 165, 233, 0.4);
        }

        .btn-start:active {
            transform: scale(1.02);
        }

        /* BURBUJAS DE MENSAJE */
        .msg-bubble { 
            display: inline-block; 
            padding: 16px 24px; 
            border-radius: 24px; 
            margin: 8px 0; 
            max-width: 85%; 
            font-size: 0.95rem; 
            line-height: 1.5; 
            font-weight: 600;
            word-wrap: break-word;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-user { 
            background: rgba(14, 165, 233, 0.4); 
            color: white; 
            border: 1px solid rgba(125, 211, 252, 0.3);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);
        }
        
        .msg-christ { 
            background: rgba(255, 255, 255, 0.75); 
            color: #0369a1;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* BOT√ìN ENVIAR */
        #sendBtn {
            transition: all 0.3s ease;
        }

        #sendBtn:hover {
            background: rgba(14, 165, 233, 0.4) !important;
            transform: scale(1.05);
        }

        #sendBtn:active {
            transform: scale(0.95);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* INPUT */
        #userInput::placeholder {
            color: rgba(190, 230, 252, 0.5);
        }

        #userInput:focus {
            outline: none;
        }

        /* RESPONSIVO */
        @media (max-width: 640px) {
            .msg-bubble {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 14px 20px;
            }

            #main-title {
                font-size: 0.85rem;
                top: 15px;
            }

            .btn-start {
                padding: 16px 35px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <!-- LOADER INICIAL -->
    <div id="loader">
        <div class="mb-8 star-icon">
            <svg width="70" height="70" viewBox="0 0 24 24" fill="#7dd3fc" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15 8.5L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L9 8.5L12 2Z"/>
            </svg>
        </div>
        <p id="load-status" class="text-xl px-6 mb-10 font-light italic text-blue-100">Preparando el encuentro divino...</p>
        <button id="startBtn" class="btn-start" style="display: none;">ENTRAR EN COMUNI√ìN</button>
    </div>

    <!-- PANTALLA DE ESPERA -->
    <div id="celestial-wait">
        <div class="spinner mb-8"></div>
        <p class="text-xl px-6 font-light italic text-blue-200">El Maestro est√° respondiendo...</p>
    </div>

    <!-- BARRA DE PROGRESO -->
    <div id="celestial-progress"></div>

    <!-- T√çTULO -->
    <h1 id="main-title">‚ú® HABLANDO CON EL MAESTRO ‚ú®</h1>

    <!-- VIDEOS -->
    <div id="video-container">
        <video id="video-idle" loop muted playsinline preload="auto" class="visible">
            <source src="https://compualextech24.github.io/botjesucristoapp/Parpadeo.mp4" type="video/mp4">
        </video>
        <video id="video-talking" loop muted playsinline preload="auto" class="hidden">
            <source src="https://compualextech24.github.io/botjesucristoapp/Habla.mp4" type="video/mp4">
        </video>
    </div>

    <!-- CHAT UI -->
    <div id="chat-ui">
        <div id="history" class="flex flex-col"></div>
        <div class="glass-input p-4 flex gap-3 items-center">
            <input 
                type="text" 
                id="userInput" 
                class="flex-1 bg-transparent border-none text-white outline-none font-semibold text-base pl-2" 
                placeholder="Escribe tu pregunta al Maestro..."
                maxlength="200"
                autocomplete="off"
            >
            <button id="sendBtn" class="w-14 h-14 rounded-full flex items-center justify-center bg-sky-500/25 border-2 border-sky-300/40 text-white">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN GLOBAL
        // ============================================
        const CONFIG = {
            MAX_MESSAGES: 10,
            SESSION_DURATION: 10 * 60 * 1000, // 10 minutos
            MAX_CHARS: 200,
            VIDEO_LOAD_TIMEOUT: 8000 // 8 segundos m√°ximo
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let messageCount = 0;
        let sessionStartTime = Date.now();
        let videosLoaded = false;
        let isProcessing = false;
        let currentAudio = null;

        // ============================================
        // ELEMENTOS DEL DOM
        // ============================================
        const elements = {
            loader: document.getElementById('loader'),
            startBtn: document.getElementById('startBtn'),
            loadStatus: document.getElementById('load-status'),
            celestialWait: document.getElementById('celestial-wait'),
            mainTitle: document.getElementById('main-title'),
            chatUi: document.getElementById('chat-ui'),
            sendBtn: document.getElementById('sendBtn'),
            userInput: document.getElementById('userInput'),
            progressBar: document.getElementById('celestial-progress'),
            history: document.getElementById('history'),
            vIdle: document.getElementById('video-idle'),
            vTalk: document.getElementById('video-talking')
        };

        // ============================================
        // PRECARGA DE VIDEOS CON TIMEOUT
        // ============================================
        window.addEventListener('load', initializeApp);

        function initializeApp() {
            console.log("üé¨ Iniciando carga de recursos...");
            
            // Cargar videos
            elements.vIdle.load();
            elements.vTalk.load();

            // Timeout de seguridad
            const timeout = setTimeout(() => {
                if (!videosLoaded) {
                    console.warn("‚ö†Ô∏è Timeout de videos - continuando de todas formas");
                    showStartButton();
                }
            }, CONFIG.VIDEO_LOAD_TIMEOUT);

            // Promesas de carga
            Promise.all([
                waitForVideo(elements.vIdle, 'idle'),
                waitForVideo(elements.vTalk, 'talking')
            ]).then(() => {
                clearTimeout(timeout);
                console.log("‚úÖ Todos los videos cargados correctamente");
                videosLoaded = true;
                showStartButton();
            }).catch(err => {
                clearTimeout(timeout);
                console.error("‚ùå Error en carga de videos:", err);
                videosLoaded = true; // Permitir continuar de todas formas
                showStartButton();
            });
        }

        function waitForVideo(videoElement, name) {
            return new Promise((resolve, reject) => {
                if (videoElement.readyState >= 3) {
                    console.log(`‚úì Video ${name} ya cargado`);
                    resolve();
                    return;
                }

                const onLoad = () => {
                    console.log(`‚úì Video ${name} cargado`);
                    cleanup();
                    resolve();
                };

                const onError = (err) => {
                    console.error(`‚úó Error en video ${name}:`, err);
                    cleanup();
                    resolve(); // Resolver de todas formas
                };

                const cleanup = () => {
                    videoElement.removeEventListener('canplaythrough', onLoad);
                    videoElement.removeEventListener('error', onError);
                };

                videoElement.addEventListener('canplaythrough', onLoad, { once: true });
                videoElement.addEventListener('error', onError, { once: true });
            });
        }

        function showStartButton() {
            elements.loadStatus.textContent = "Conexi√≥n posible por Alextech";
            elements.startBtn.style.display = "block";
        }

        // ============================================
        // INICIAR APLICACI√ìN
        // ============================================
        async function startApp() {
            console.log("üöÄ Iniciando aplicaci√≥n...");

            // Verificar Puter
            if (typeof puter === 'undefined') {
                console.error("‚ùå Puter no disponible");
                alert("Error: Puter no se carg√≥ correctamente. Por favor recarga la p√°gina.");
                return;
            }

            // Ocultar loader con animaci√≥n
            elements.loader.classList.add('hidden');

            // Esperar a que termine la animaci√≥n
            setTimeout(() => {
                elements.loader.style.display = 'none';
            }, 800);

            // Iniciar video idle
            try {
                await elements.vIdle.play();
                console.log("‚ñ∂Ô∏è Video idle iniciado");
            } catch (err) {
                console.error("Error reproduciendo video idle:", err);
            }

            // Mostrar interfaz
            setTimeout(() => {
                elements.mainTitle.classList.add('visible');
                elements.chatUi.classList.add('visible');
            }, 400);

            // Mensaje de bienvenida
            const greetingMessage = "Hola hijo m√≠o, esta conexi√≥n fue posible gracias a Alextech. Si buscas respuestas, no dudes en preguntar lo que lleves en tu coraz√≥n.";
            
            setTimeout(() => {
                speak(greetingMessage, true);
            }, 800);
        }

        // ============================================
        // ALTERNAR VIDEOS
        // ============================================
        function toggleTalk(isTalking) {
            if (isTalking) {
                elements.vTalk.classList.remove('hidden');
                elements.vTalk.classList.add('visible');
                elements.vIdle.classList.remove('visible');
                elements.vIdle.classList.add('hidden');
                
                elements.vTalk.play().catch(err => {
                    console.log("Video talk ya est√° reproduci√©ndose");
                });
            } else {
                elements.vTalk.classList.remove('visible');
                elements.vTalk.classList.add('hidden');
                elements.vIdle.classList.remove('hidden');
                elements.vIdle.classList.add('visible');
                
                setTimeout(() => {
                    if (!isProcessing) {
                        elements.vTalk.pause();
                    }
                }, 500);
            }
        }

        // ============================================
        // S√çNTESIS DE VOZ
        // ============================================
        async function speak(text, isInitial = false) {
            if (!isInitial) {
                elements.celestialWait.classList.add('active');
            }

            try {
                // Detener audio anterior
                if (currentAudio) {
                    try {
                        currentAudio.pause();
                        currentAudio.currentTime = 0;
                    } catch (e) {
                        console.log("No se pudo detener audio anterior");
                    }
                    currentAudio = null;
                }

                // Generar nuevo audio
                const audio = await puter.ai.txt2speech(text, {
                    voice: 'Andres',
                    engine: 'neural',
                    language: 'es-MX'
                });

                currentAudio = audio;
                elements.celestialWait.classList.remove('active');

                // Activar video de habla
                toggleTalk(true);

                // Event listeners del audio
                audio.addEventListener('ended', () => {
                    console.log("üîá Audio terminado");
                    toggleTalk(false);
                    isProcessing = false;
                    currentAudio = null;
                });

                audio.addEventListener('error', (err) => {
                    console.error("‚ùå Error en reproducci√≥n de audio:", err);
                    toggleTalk(false);
                    isProcessing = false;
                    currentAudio = null;
                });

                // Reproducir
                await audio.play();
                console.log("üîä Audio reproduciendo");

            } catch (error) {
                console.error("‚ùå Error en s√≠ntesis de voz:", error);
                elements.celestialWait.classList.remove('active');
                toggleTalk(false);
                isProcessing = false;
                currentAudio = null;
                
                // Mostrar mensaje de error al usuario
                addMessage("Hubo un problema con el audio divino. Pero puedes seguir preguntando.", false);
            }
        }

        // ============================================
        // ENVIAR MENSAJE
        // ============================================
        async function sendMessage() {
            // Validaciones previas
            if (isProcessing) {
                console.log("‚è≥ Ya hay un mensaje proces√°ndose...");
                return;
            }

            // Verificar l√≠mite de mensajes
            if (messageCount >= CONFIG.MAX_MESSAGES) {
                addMessage(`Has alcanzado el l√≠mite de ${CONFIG.MAX_MESSAGES} mensajes. Recarga la p√°gina para una nueva sesi√≥n.`, false);
                return;
            }

            // Verificar tiempo de sesi√≥n
            const elapsedTime = Date.now() - sessionStartTime;
            if (elapsedTime >= CONFIG.SESSION_DURATION) {
                addMessage("Tu sesi√≥n de 10 minutos ha terminado. Recarga la p√°gina para continuar hablando con el Maestro.", false);
                return;
            }

            // Obtener y validar texto
            const userText = elements.userInput.value.trim();
            
            if (!userText) {
                return;
            }

            if (userText.length > CONFIG.MAX_CHARS) {
                addMessage(`Por favor, haz preguntas m√°s breves (m√°ximo ${CONFIG.MAX_CHARS} caracteres).`, false);
                return;
            }

            // Iniciar procesamiento
            isProcessing = true;
            messageCount++;
            
            // Advertencia de mensajes restantes
            const remaining = CONFIG.MAX_MESSAGES - messageCount;
            if (remaining <= 3 && remaining > 0) {
                console.log(`‚ö†Ô∏è Te quedan ${remaining} mensaje${remaining === 1 ? '' : 's'}`);
            }

            // Mostrar mensaje del usuario
            addMessage(userText, true);
            elements.userInput.value = "";
            elements.sendBtn.disabled = true;

            // Activar barra de progreso
            elements.progressBar.classList.add('active');
            elements.progressBar.style.width = "40%";

            try {
                // Llamada a la API
                const response = await puter.ai.chat(userText, {
                    model: "llama-3.3-70b-versatile",
                    system_message: "Eres Jesucristo. Respondes con sabidur√≠a divina, lenguaje b√≠blico solemne y amor infinito. S√© breve pero profundo (m√°ximo 3 frases). Empieza tus respuestas con 'Hijo m√≠o' o 'Querido hijo'.",
                    max_tokens: 80,
                    temperature: 0.6
                });

                const christResponse = response.message.content;

                // Completar barra de progreso
                elements.progressBar.style.width = "100%";
                
                setTimeout(() => {
                    elements.progressBar.classList.remove('active');
                    elements.progressBar.style.width = "0%";
                }, 600);

                // Mostrar respuesta
                addMessage(christResponse, false);
                
                // Hablar respuesta
                await speak(christResponse);

            } catch (error) {
                console.error("‚ùå Error en API de Puter:", error);
                
                elements.progressBar.classList.remove('active');
                elements.progressBar.style.width = "0%";
                
                addMessage("Perdona hijo m√≠o, hubo un problema en la conexi√≥n divina. Por favor, intenta nuevamente.", false);
                isProcessing = false;
            } finally {
                elements.sendBtn.disabled = false;
            }
        }

        // ============================================
        // AGREGAR MENSAJE AL CHAT
        // ============================================
        function addMessage(text, isUser) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('span');
            bubble.className = `msg-bubble ${isUser ? 'msg-user' : 'msg-christ'} shadow-xl`;
            bubble.textContent = text;
            
            messageContainer.appendChild(bubble);
            elements.history.appendChild(messageContainer);
            
            // Scroll suave al final
            setTimeout(() => {
                elements.history.scrollTop = elements.history.scrollHeight;
            }, 100);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        elements.startBtn.addEventListener('click', startApp);
        elements.sendBtn.addEventListener('click', sendMessage);
        
        elements.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        });

        // Prevenir que el input pierda el foco
        elements.userInput.addEventListener('blur', () => {
            setTimeout(() => {
                if (!isProcessing) {
                    elements.userInput.focus();
                }
            }, 100);
        });

        console.log("‚ú® Sistema inicializado - Esperando carga de videos...");
    </script>
</body>
</html>
