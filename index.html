<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hablando con el Maestro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html { 
            height: 100%; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #loader { 
            position: fixed; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: radial-gradient(circle at center, #1a1a3e 0%, #000 100%); 
            color: white; 
            z-index: 200; 
            text-align: center;
            opacity: 1;
            transition: opacity 0.8s ease-out;
        }
        
        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #celestial-wait { 
            position: fixed;
            inset: 0;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            z-index: 150;
        }

        #celestial-wait.active {
            display: flex;
        }

        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(125, 211, 252, 0.2);
            border-top: 5px solid #7dd3fc;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(125, 211, 252, 0.6));
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .star-icon {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                filter: drop-shadow(0 0 15px #0ea5e9);
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 30px #7dd3fc);
                transform: scale(1.1);
            }
        }

        #celestial-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9, #fff, #7dd3fc);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.8);
            z-index: 160;
            transition: width 0.5s ease, opacity 0.3s;
            opacity: 0;
        }

        #celestial-progress.active {
            opacity: 1;
        }

        #video-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            background: #000; 
        }

video { 
    position: absolute;
    top: 0;
    left: 0;
    width: 100%; 
    height: 100%; 
    object-fit: cover;
    transition: opacity 0.3s ease-in-out;
    will-change: opacity;
    backface-visibility: hidden;
}
        
        #main-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: clamp(0.8rem, 2.5vw, 1.1rem);
            font-weight: 900; 
            letter-spacing: 1px; 
            text-shadow: 0 0 20px rgba(125, 211, 252, 0.9);
            z-index: 100;
            opacity: 0;
            width: 95%; 
            text-align: center;
            text-transform: uppercase;
            transition: opacity 0.8s ease-in;
            padding: 10px;
        }

        #main-title.visible {
            opacity: 1;
        }
        
        #chat-ui { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 95%; 
            max-width: 850px; 
            opacity: 0;
            z-index: 100;
            transition: opacity 0.8s ease-in;
        }

        #chat-ui.visible {
            opacity: 1;
        }
        
        #history { 
            max-height: 45vh; 
            overflow-y: auto; 
            margin-bottom: 15px; 
            padding: 10px 5px; 
            scroll-behavior: smooth;
        }
        
        #history::-webkit-scrollbar { 
            width: 5px; 
        }

        #history::-webkit-scrollbar-track {
            background: rgba(125, 211, 252, 0.1);
            border-radius: 10px;
        }

        #history::-webkit-scrollbar-thumb {
            background: rgba(125, 211, 252, 0.4);
            border-radius: 10px;
        }

        .glass-input { 
            background: rgba(3, 105, 161, 0.3); 
            backdrop-filter: blur(25px); 
            border: 2px solid rgba(125, 211, 252, 0.3); 
            border-radius: 30px; 
            position: relative; 
            overflow: visible;
            min-height: 56px;
            box-shadow: 0 8px 32px rgba(14, 165, 233, 0.2);
            transition: border 0.3s ease;
        }

        .glass-input:focus-within {
            border-color: rgba(125, 211, 252, 0.6);
        }

        .btn-start { 
            background: linear-gradient(135deg, #fff 0%, #e0f2fe 100%);
            color: #0369a1; 
            padding: 20px 50px; 
            border-radius: 60px; 
            font-weight: 900; 
            cursor: pointer; 
            box-shadow: 0 0 50px rgba(125, 211, 252, 0.4);
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1rem;
            border: none;
        }

        .btn-start:hover {
            transform: scale(1.05);
            box-shadow: 0 0 70px rgba(125, 211, 252, 0.6);
        }

        .msg-bubble { 
            display: inline-block; 
            padding: 16px 24px; 
            border-radius: 24px; 
            margin: 8px 0; 
            max-width: 85%; 
            font-size: 0.95rem; 
            line-height: 1.5; 
            font-weight: 600;
            word-wrap: break-word;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-user { 
            background: rgba(14, 165, 233, 0.4); 
            color: white; 
            border: 1px solid rgba(125, 211, 252, 0.3);
        }
        
        .msg-christ { 
            background: rgba(255, 255, 255, 0.75); 
            color: #0369a1;
        }

        #sendBtn:hover {
            background: rgba(14, 165, 233, 0.4);
            transform: scale(1.05);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="mb-8 star-icon">
            <svg width="70" height="70" viewBox="0 0 24 24" fill="#7dd3fc" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L15 8.5L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L9 8.5L12 2Z"/>
            </svg>
        </div>
        <p id="load-status" class="text-xl px-6 mb-10 font-light italic text-blue-100">Preparando el encuentro divino...</p>
        <button id="startBtn" class="btn-start" style="display: none;">ENTRAR EN COMUNI√ìN</button>
    </div>

    <div id="celestial-wait">
        <div class="spinner mb-8"></div>
        <p class="text-xl px-6 font-light italic text-blue-200">El Maestro est√° respondiendo...</p>
    </div>

    <div id="celestial-progress"></div>

    <h1 id="main-title">‚ú® HABLANDO CON EL MAESTRO ‚ú®</h1>

    <div id="video-container">
       <video id="video-idle" loop muted playsinline preload="auto" style="opacity: 1; z-index: 2;">
            <source src="https://compualextech24.github.io/botjesucristoapp/Parpadeo.mp4" type="video/mp4">
        </video>
        <video id="video-talking" loop muted playsinline preload="auto" style="opacity: 0; z-index: 1;">
            <source src="https://compualextech24.github.io/botjesucristoapp/Habla.mp4" type="video/mp4">
        </video>
    </div>

    <div id="chat-ui">
        <div id="history" class="flex flex-col"></div>
        <div class="glass-input p-4 flex gap-3 items-center">
            <input 
                type="text" 
                id="userInput" 
                class="flex-1 bg-transparent border-none text-white outline-none font-semibold text-base pl-2" 
                placeholder="Escribe tu pregunta al Maestro..."
                maxlength="200"
            >
            <button id="sendBtn" class="w-14 h-14 rounded-full flex items-center justify-center bg-sky-500/25 border-2 border-sky-300/40 text-white transition-all">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const GROQ_API_KEY = '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';
        const MAX_MESSAGES = 10;
        const SESSION_DURATION = 10 * 60 * 1000;
        
        let messageCount = 0;
        let sessionStartTime = Date.now();
        let videosLoaded = false;
        let isProcessing = false;
        let currentAudio = null;

        // ============================================
        // ELEMENTOS DOM
        // ============================================
        const el = {
            loader: document.getElementById('loader'),
            startBtn: document.getElementById('startBtn'),
            loadStatus: document.getElementById('load-status'),
            celestialWait: document.getElementById('celestial-wait'),
            mainTitle: document.getElementById('main-title'),
            chatUi: document.getElementById('chat-ui'),
            sendBtn: document.getElementById('sendBtn'),
            userInput: document.getElementById('userInput'),
            progressBar: document.getElementById('celestial-progress'),
            history: document.getElementById('history'),
            vIdle: document.getElementById('video-idle'),
            vTalk: document.getElementById('video-talking')
        };

        // ============================================
        // PRECARGA VIDEOS
        // ============================================
        window.addEventListener('load', () => {
            console.log("üé¨ Cargando videos...");
            
            el.vIdle.load();
            el.vTalk.load();

            const timeout = setTimeout(() => {
                console.log("‚úÖ Timeout alcanzado - continuando");
                showStart();
            }, 8000);

            Promise.all([
                new Promise(resolve => {
                    if (el.vIdle.readyState >= 3) resolve();
                    else {
                        el.vIdle.addEventListener('canplaythrough', resolve, { once: true });
                        el.vIdle.addEventListener('error', resolve, { once: true });
                    }
                }),
                new Promise(resolve => {
                    if (el.vTalk.readyState >= 3) resolve();
                    else {
                        el.vTalk.addEventListener('canplaythrough', resolve, { once: true });
                        el.vTalk.addEventListener('error', resolve, { once: true });
                    }
                })
            ]).then(() => {
                clearTimeout(timeout);
                console.log("‚úÖ Videos cargados");
                videosLoaded = true;
                showStart();
            });
        });

        function showStart() {
            el.loadStatus.textContent = "Conexi√≥n posible por Alextech";
            el.startBtn.style.display = "block";
        }

        // ============================================
        // INICIAR APP
        // ============================================
        async function startApp() {
            console.log("üöÄ Iniciando...");
            
            el.loader.classList.add('hidden');
            
            el.vIdle.play().catch(e => console.log("Video idle play:", e));
            
            setTimeout(() => {
                el.mainTitle.classList.add('visible');
                el.chatUi.classList.add('visible');
            }, 500);

            const greeting = "Hola hijo m√≠o, esta conexi√≥n fue posible gracias a Alextech. Si buscas respuestas, no dudes en preguntar.";
            
            setTimeout(() => {
                speak(greeting, true);
            }, 1000);
        }

        // ============================================
        // ALTERNAR VIDEOS
        // ============================================
       function toggleTalk(isTalking) {
    if (isTalking) {
        // Asegurar que el video de hablar est√© listo ANTES de cambiar
        if (el.vTalk.readyState < 3) {
            el.vTalk.load();
        }
        
        el.vTalk.currentTime = 0;
        el.vTalk.play().then(() => {
            el.vTalk.style.opacity = "1";
            el.vTalk.style.zIndex = "2";
            el.vIdle.style.opacity = "0";
            el.vIdle.style.zIndex = "1";
        }).catch(() => {
            console.log("Error reproduciendo video talking");
        });
    } else {
        el.vTalk.style.opacity = "0";
        el.vTalk.style.zIndex = "1";
        el.vIdle.style.opacity = "1";
        el.vIdle.style.zIndex = "2";
        
        setTimeout(() => {
            el.vTalk.pause();
            el.vTalk.currentTime = 0;
        }, 300);
    }
}
        // ============================================
        // S√çNTESIS DE VOZ (PUTER)
        // ============================================
        async function speak(text, isInitial = false) {
            if (!isInitial) {
                el.celestialWait.classList.add('active');
            }

            try {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                const audio = await puter.ai.txt2speech(text, {
                    voice: 'Andres',
                    engine: 'neural',
                    language: 'es-MX'
                });

                currentAudio = audio;
                el.celestialWait.classList.remove('active');

                toggleTalk(true);

                audio.addEventListener('ended', () => {
                    console.log("üîá Audio finalizado");
                    toggleTalk(false);
                    isProcessing = false;
                    currentAudio = null;
                });

                audio.addEventListener('error', () => {
                    toggleTalk(false);
                    isProcessing = false;
                    currentAudio = null;
                });

                await audio.play();
                console.log("üîä Audio reproduciendo");

            } catch (error) {
                console.error("‚ùå Error audio:", error);
                el.celestialWait.classList.remove('active');
                toggleTalk(false);
                isProcessing = false;
            }
        }

        // ============================================
        // ENVIAR MENSAJE (GROQ API)
        // ============================================
        async function sendMessage() {
            if (isProcessing) return;

            if (messageCount >= MAX_MESSAGES) {
                addMsg("Has alcanzado el l√≠mite de 10 mensajes. Recarga para continuar.", false);
                return;
            }

            const elapsed = Date.now() - sessionStartTime;
            if (elapsed >= SESSION_DURATION) {
                addMsg("Tu sesi√≥n de 10 minutos ha terminado. Recarga la p√°gina.", false);
                return;
            }

            const text = el.userInput.value.trim();
            if (!text) return;
            
            if (text.length > 200) {
                addMsg("Por favor, haz preguntas m√°s breves (m√°ximo 200 caracteres).", false);
                return;
            }

            isProcessing = true;
            messageCount++;

            const remaining = MAX_MESSAGES - messageCount;
            if (remaining <= 3) {
                console.log(`‚ö†Ô∏è Te quedan ${remaining} mensajes`);
            }

            addMsg(text, true);
            el.userInput.value = "";
            el.sendBtn.disabled = true;

            el.progressBar.classList.add('active');
            el.progressBar.style.width = "40%";

            try {
                // ============================================
                // LLAMADA A GROQ API
                // ============================================
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres Jesucristo. Respondes con sabidur√≠a divina y lenguaje b√≠blico solemne. S√© breve pero profundo (m√°ximo 3 frases). Empieza con "Hijo m√≠o" o "Querido hijo".'
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        max_tokens: 80,
                        temperature: 0.6
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error API: ${response.status}`);
                }

                const data = await response.json();
                const christResponse = data.choices[0].message.content;

                console.log("‚úÖ Respuesta de Groq:", christResponse);

                el.progressBar.style.width = "100%";
                
                setTimeout(() => {
                    el.progressBar.classList.remove('active');
                    el.progressBar.style.width = "0%";
                }, 600);

                addMsg(christResponse, false);
                await speak(christResponse);

            } catch (error) {
                console.error("‚ùå Error Groq:", error);
                
                el.progressBar.classList.remove('active');
                el.progressBar.style.width = "0%";
                
                addMsg("Perdona hijo m√≠o, hubo un problema en la conexi√≥n divina. Intenta nuevamente.", false);
                isProcessing = false;
            } finally {
                el.sendBtn.disabled = false;
            }
        }

        // ============================================
        // AGREGAR MENSAJE
        // ============================================
        function addMsg(text, isUser) {
            const div = document.createElement('div');
            div.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('span');
            bubble.className = `msg-bubble ${isUser ? 'msg-user' : 'msg-christ'}`;
            bubble.textContent = text;
            
            div.appendChild(bubble);
            el.history.appendChild(div);
            
            setTimeout(() => {
                el.history.scrollTop = el.history.scrollHeight;
            }, 100);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        el.startBtn.addEventListener('click', startApp);
        el.sendBtn.addEventListener('click', sendMessage);
        el.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isProcessing) sendMessage();
        });

        console.log("‚ú® Sistema listo");
    </script>
</body>
</html>
